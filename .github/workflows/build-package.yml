name: Build Package

on: 
  push:
    tags: [ '*' ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: true

    - name: fpm
      run: gem install fpm -v 1.11.0

    - name: deps
      run: |
        sudo add-apt-repository -y ppa:ondrej/apache2
        sudo apt install -y python3-dev build-essential bison flex libaprutil1-dev rpm swig 

    - name: autogen
      run: ./autogen.sh

    - name: make install
      run: make && sudo make install

    - name: make python-rpm
      run: make python-rpm

    - name: make rpm
      run: make rpm

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        draft: true
        files: |
          *.rpm